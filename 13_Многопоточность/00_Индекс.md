# üîÄ –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤ Rust

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞

1. [–ü–æ—Ç–æ–∫–∏ (Threads)](#–ø–æ—Ç–æ–∫–∏-threads)
2. [–ö–∞–Ω–∞–ª—ã (Channels)](#–∫–∞–Ω–∞–ª—ã-channels)
3. [–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Shared State)](#–æ–±—â–µ–µ-—Å–æ—Å—Ç–æ—è–Ω–∏–µ)
4. [Send –∏ Sync —Ç—Ä–µ–π—Ç—ã](#send-–∏-sync)
5. [–ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞](#–ø–∞—Ç—Ç–µ—Ä–Ω—ã-–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞)
6. [Rayon - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã](#rayon)

## üéØ Fearless Concurrency

Rust –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º—ã —Ç–∏–ø–æ–≤. –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏!

### –û—Å–Ω–æ–≤–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏
- –ù–µ—Ç –≥–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö (data races)
- –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
- –ù–µ—Ç –Ω—É–ª–µ–≤—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏ –±–µ–∑ —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞

## üßµ –ü–æ—Ç–æ–∫–∏ (Threads)

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤
```rust
use std::thread;
use std::time::Duration;

fn main() {
    // –ü—Ä–æ—Å—Ç–æ–π –ø–æ—Ç–æ–∫
    let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(|| {
        for i in 1..10 {
            println!("–ü—Ä–∏–≤–µ—Ç –Ω–æ–º–µ—Ä {} –∏–∑ –ø–æ—Ä–æ–∂–¥—ë–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞!", i);
            thread::sleep(Duration::from_millis(1));
        }
    });
    
    for i in 1..5 {
        println!("–ü—Ä–∏–≤–µ—Ç –Ω–æ–º–µ—Ä {} –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞!", i);
        thread::sleep(Duration::from_millis(1));
    }
    
    // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
    –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
}
```

### –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ç–æ–∫–∏
```rust
use std::thread;

fn main() {
    let –≤–µ–∫—Ç–æ—Ä = vec![1, 2, 3];
    
    // move –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –≤–ª–∞–¥–µ–Ω–∏–µ –≤ –ø–æ—Ç–æ–∫
    let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
        println!("–í–µ–∫—Ç–æ—Ä: {:?}", –≤–µ–∫—Ç–æ—Ä);
    });
    
    // println!("{:?}", –≤–µ–∫—Ç–æ—Ä); // –û—à–∏–±–∫–∞! –≤–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ–º–µ—â—ë–Ω
    
    –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
}
```

### –í–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –ø–æ—Ç–æ–∫–æ–≤
```rust
use std::thread;

fn main() {
    let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(|| {
        let —Å—É–º–º–∞: i32 = (1..=100).sum();
        —Å—É–º–º–∞ // –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    });
    
    let —Ä–µ–∑—É–ª—å—Ç–∞—Ç = –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
    println!("–°—É–º–º–∞ –æ—Ç 1 –¥–æ 100: {}", —Ä–µ–∑—É–ª—å—Ç–∞—Ç);
}
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤
```rust
use std::thread;

fn main() {
    let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
    
    for i in 0..10 {
        let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
            let —Ä–µ–∑—É–ª—å—Ç–∞—Ç = –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ(i);
            println!("–ü–æ—Ç–æ–∫ {} –∑–∞–≤–µ—Ä—à—ë–Ω: {}", i, —Ä–µ–∑—É–ª—å—Ç–∞—Ç);
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        });
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
    }
    
    let mut —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã = vec![];
    for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap());
    }
    
    println!("–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: {:?}", —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã);
}

fn –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ(n: i32) -> i32 {
    n * n
}
```

## üì¨ –ö–∞–Ω–∞–ª—ã (Channels)

### –ü—Ä–æ—Å—Ç–æ–π –∫–∞–Ω–∞–ª (mpsc)
```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    // Multiple Producer, Single Consumer
    let (–ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫, –ø—Ä–∏—ë–º–Ω–∏–∫) = mpsc::channel();
    
    thread::spawn(move || {
        let —Å–æ–æ–±—â–µ–Ω–∏–µ = String::from("–ø—Ä–∏–≤–µ—Ç");
        –ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫.send(—Å–æ–æ–±—â–µ–Ω–∏–µ).unwrap();
        // println!("{}", —Å–æ–æ–±—â–µ–Ω–∏–µ); // –û—à–∏–±–∫–∞! —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ
    });
    
    let –ø–æ–ª—É—á–µ–Ω–æ = –ø—Ä–∏—ë–º–Ω–∏–∫.recv().unwrap();
    println!("–ü–æ–ª—É—á–µ–Ω–æ: {}", –ø–æ–ª—É—á–µ–Ω–æ);
}
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;

fn main() {
    let (tx, rx) = mpsc::channel();
    
    thread::spawn(move || {
        let –∑–Ω–∞—á–µ–Ω–∏—è = vec![
            String::from("–ø—Ä–∏–≤–µ—Ç"),
            String::from("–∏–∑"),
            String::from("–ø–æ—Ç–æ–∫–∞"),
        ];
        
        for –∑–Ω–∞—á–µ–Ω–∏–µ in –∑–Ω–∞—á–µ–Ω–∏—è {
            tx.send(–∑–Ω–∞—á–µ–Ω–∏–µ).unwrap();
            thread::sleep(Duration::from_secs(1));
        }
    });
    
    // –ü—Ä–∏—ë–º–Ω–∏–∫ –∫–∞–∫ –∏—Ç–µ—Ä–∞—Ç–æ—Ä
    for –ø–æ–ª—É—á–µ–Ω–æ in rx {
        println!("–ü–æ–ª—É—á–µ–Ω–æ: {}", –ø–æ–ª—É—á–µ–Ω–æ);
    }
}
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏
```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();
    
    let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
    
    for i in 0..5 {
        let tx_–∫–ª–æ–Ω = tx.clone();
        let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
            tx_–∫–ª–æ–Ω.send(format!("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ—Ç–æ–∫–∞ {}", i)).unwrap();
        });
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
    }
    
    drop(tx); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫
    
    for —Å–æ–æ–±—â–µ–Ω–∏–µ in rx {
        println!("–ü–æ–ª—É—á–µ–Ω–æ: {}", —Å–æ–æ–±—â–µ–Ω–∏–µ);
    }
    
    for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
    }
}
```

### –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    // –ö–∞–Ω–∞–ª —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –±—É—Ñ–µ—Ä–æ–º
    let (tx, rx) = mpsc::sync_channel(3);
    
    thread::spawn(move || {
        for i in 0..10 {
            println!("–û—Ç–ø—Ä–∞–≤–ª—è—é: {}", i);
            tx.send(i).unwrap();
            // –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –±—É—Ñ–µ—Ä –ø–æ–ª–æ–Ω
        }
    });
    
    thread::sleep(std::time::Duration::from_secs(2));
    
    for –∑–Ω–∞—á–µ–Ω–∏–µ in rx {
        println!("–ü–æ–ª—É—á–µ–Ω–æ: {}", –∑–Ω–∞—á–µ–Ω–∏–µ);
        thread::sleep(std::time::Duration::from_millis(500));
    }
}
```

## üîí –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Shared State)

### Mutex (Mutual Exclusion)
```rust
use std::sync::Mutex;

fn main() {
    let –º = Mutex::new(5);
    
    {
        let mut num = –º.lock().unwrap();
        *num = 6;
    } // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è
    
    println!("–º = {:?}", –º);
}
```

### Mutex –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å Arc
```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let —Å—á—ë—Ç—á–∏–∫ = Arc::new(Mutex::new(0));
    let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
    
    for _ in 0..10 {
        let —Å—á—ë—Ç—á–∏–∫ = Arc::clone(&—Å—á—ë—Ç—á–∏–∫);
        let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
            let mut num = —Å—á—ë—Ç—á–∏–∫.lock().unwrap();
            *num += 1;
        });
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
    }
    
    for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
    }
    
    println!("–†–µ–∑—É–ª—å—Ç–∞—Ç: {}", *—Å—á—ë—Ç—á–∏–∫.lock().unwrap());
}
```

### RwLock (Read-Write Lock)
```rust
use std::sync::{Arc, RwLock};
use std::thread;

fn main() {
    let –¥–∞–Ω–Ω—ã–µ = Arc::new(RwLock::new(vec![1, 2, 3]));
    
    // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π
    let mut —á–∏—Ç–∞—Ç–µ–ª–∏ = vec![];
    for i in 0..5 {
        let –¥–∞–Ω–Ω—ã–µ = Arc::clone(&–¥–∞–Ω–Ω—ã–µ);
        —á–∏—Ç–∞—Ç–µ–ª–∏.push(thread::spawn(move || {
            let —á—Ç–µ–Ω–∏–µ = –¥–∞–Ω–Ω—ã–µ.read().unwrap();
            println!("–ß–∏—Ç–∞—Ç–µ–ª—å {}: {:?}", i, *—á—Ç–µ–Ω–∏–µ);
        }));
    }
    
    // –û–¥–∏–Ω –ø–∏—Å–∞—Ç–µ–ª—å
    let –¥–∞–Ω–Ω—ã–µ_–¥–ª—è_–∑–∞–ø–∏—Å–∏ = Arc::clone(&–¥–∞–Ω–Ω—ã–µ);
    let –ø–∏—Å–∞—Ç–µ–ª—å = thread::spawn(move || {
        let mut –∑–∞–ø–∏—Å—å = –¥–∞–Ω–Ω—ã–µ_–¥–ª—è_–∑–∞–ø–∏—Å–∏.write().unwrap();
        –∑–∞–ø–∏—Å—å.push(4);
        println!("–ó–∞–ø–∏—Å–∞–Ω–æ: {:?}", *–∑–∞–ø–∏—Å—å);
    });
    
    for —á–∏—Ç–∞—Ç–µ–ª—å in —á–∏—Ç–∞—Ç–µ–ª–∏ {
        —á–∏—Ç–∞—Ç–µ–ª—å.join().unwrap();
    }
    –ø–∏—Å–∞—Ç–µ–ª—å.join().unwrap();
}
```

### Condvar (–£—Å–ª–æ–≤–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è)
```rust
use std::sync::{Arc, Mutex, Condvar};
use std::thread;

fn main() {
    let –ø–∞—Ä–∞ = Arc::new((Mutex::new(false), Condvar::new()));
    let –ø–∞—Ä–∞2 = Arc::clone(&–ø–∞—Ä–∞);
    
    thread::spawn(move || {
        let (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, —É—Å–ª–æ–≤–∏–µ) = &*–ø–∞—Ä–∞2;
        let mut –≥–æ—Ç–æ–≤–æ = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.lock().unwrap();
        *–≥–æ—Ç–æ–≤–æ = true;
        —É—Å–ª–æ–≤–∏–µ.notify_one();
    });
    
    let (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, —É—Å–ª–æ–≤–∏–µ) = &*–ø–∞—Ä–∞;
    let mut –≥–æ—Ç–æ–≤–æ = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.lock().unwrap();
    while !*–≥–æ—Ç–æ–≤–æ {
        –≥–æ—Ç–æ–≤–æ = —É—Å–ª–æ–≤–∏–µ.wait(–≥–æ—Ç–æ–≤–æ).unwrap();
    }
    
    println!("–ì–æ—Ç–æ–≤–æ!");
}
```

## üöÄ Send –∏ Sync —Ç—Ä–µ–π—Ç—ã

### Send - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏
```rust
// –¢–∏–ø—ã, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ Send, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏
// –ü–æ—á—Ç–∏ –≤—Å–µ —Ç–∏–ø—ã —è–≤–ª—è—é—Ç—Å—è Send, –∫—Ä–æ–º–µ Rc<T>

use std::rc::Rc;
use std::sync::Arc;

// ‚ùå Rc –Ω–µ —è–≤–ª—è–µ—Ç—Å—è Send
// let rc = Rc::new(5);
// thread::spawn(move || {
//     println!("{}", rc);
// });

// ‚úÖ Arc —è–≤–ª—è–µ—Ç—Å—è Send
let arc = Arc::new(5);
thread::spawn(move || {
    println!("{}", arc);
});
```

### Sync - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
```rust
// –¢–∏–ø—ã, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ Sync, –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–∑–¥–µ–ª—è—Ç—å –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏
// T —è–≤–ª—è–µ—Ç—Å—è Sync, –µ—Å–ª–∏ &T —è–≤–ª—è–µ—Ç—Å—è Send

// RefCell<T> –∏ Cell<T> –Ω–µ —è–≤–ª—è—é—Ç—Å—è Sync
// Mutex<T> —è–≤–ª—è–µ—Ç—Å—è Sync
```

## üé® –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

### Thread Pool
```rust
use std::sync::{Arc, Mutex, mpsc};
use std::thread;

struct –ü—É–ª–ü–æ—Ç–æ–∫–æ–≤ {
    —Ä–∞–±–æ—Ç–Ω–∏–∫–∏: Vec<–†–∞–±–æ—Ç–Ω–∏–∫>,
    –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: mpsc::Sender<–ó–∞–¥–∞—á–∞>,
}

type –ó–∞–¥–∞—á–∞ = Box<dyn FnOnce() + Send + 'static>;

impl –ü—É–ª–ü–æ—Ç–æ–∫–æ–≤ {
    fn –Ω–æ–≤—ã–π(—Ä–∞–∑–º–µ—Ä: usize) -> –ü—É–ª–ü–æ—Ç–æ–∫–æ–≤ {
        assert!(—Ä–∞–∑–º–µ—Ä > 0);
        
        let (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, –ø–æ–ª—É—á–∞—Ç–µ–ª—å) = mpsc::channel();
        let –ø–æ–ª—É—á–∞—Ç–µ–ª—å = Arc::new(Mutex::new(–ø–æ–ª—É—á–∞—Ç–µ–ª—å));
        
        let mut —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ = Vec::with_capacity(—Ä–∞–∑–º–µ—Ä);
        
        for id in 0..—Ä–∞–∑–º–µ—Ä {
            —Ä–∞–±–æ—Ç–Ω–∏–∫–∏.push(–†–∞–±–æ—Ç–Ω–∏–∫::–Ω–æ–≤—ã–π(id, Arc::clone(&–ø–æ–ª—É—á–∞—Ç–µ–ª—å)));
        }
        
        –ü—É–ª–ü–æ—Ç–æ–∫–æ–≤ { —Ä–∞–±–æ—Ç–Ω–∏–∫–∏, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å }
    }
    
    fn –≤—ã–ø–æ–ª–Ω–∏—Ç—å<F>(&self, f: F)
    where
        F: FnOnce() + Send + 'static,
    {
        let –∑–∞–¥–∞—á–∞ = Box::new(f);
        self.–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å.send(–∑–∞–¥–∞—á–∞).unwrap();
    }
}

struct –†–∞–±–æ—Ç–Ω–∏–∫ {
    id: usize,
    –ø–æ—Ç–æ–∫: thread::JoinHandle<()>,
}

impl –†–∞–±–æ—Ç–Ω–∏–∫ {
    fn –Ω–æ–≤—ã–π(id: usize, –ø–æ–ª—É—á–∞—Ç–µ–ª—å: Arc<Mutex<mpsc::Receiver<–ó–∞–¥–∞—á–∞>>>) -> –†–∞–±–æ—Ç–Ω–∏–∫ {
        let –ø–æ—Ç–æ–∫ = thread::spawn(move || loop {
            let –∑–∞–¥–∞—á–∞ = –ø–æ–ª—É—á–∞—Ç–µ–ª—å.lock().unwrap().recv().unwrap();
            println!("–†–∞–±–æ—Ç–Ω–∏–∫ {} –ø–æ–ª—É—á–∏–ª –∑–∞–¥–∞—á—É", id);
            –∑–∞–¥–∞—á–∞();
        });
        
        –†–∞–±–æ—Ç–Ω–∏–∫ { id, –ø–æ—Ç–æ–∫ }
    }
}
```

### Producer-Consumer
```rust
use std::sync::{Arc, Mutex, Condvar};
use std::collections::VecDeque;
use std::thread;

struct –û—á–µ—Ä–µ–¥—å<T> {
    –¥–∞–Ω–Ω—ã–µ: Mutex<VecDeque<T>>,
    —É—Å–ª–æ–≤–∏–µ: Condvar,
}

impl<T> –û—á–µ—Ä–µ–¥—å<T> {
    fn –Ω–æ–≤–∞—è() -> Self {
        –û—á–µ—Ä–µ–¥—å {
            –¥–∞–Ω–Ω—ã–µ: Mutex::new(VecDeque::new()),
            —É—Å–ª–æ–≤–∏–µ: Condvar::new(),
        }
    }
    
    fn –¥–æ–±–∞–≤–∏—Ç—å(&self, —ç–ª–µ–º–µ–Ω—Ç: T) {
        let mut –æ—á–µ—Ä–µ–¥—å = self.–¥–∞–Ω–Ω—ã–µ.lock().unwrap();
        –æ—á–µ—Ä–µ–¥—å.push_back(—ç–ª–µ–º–µ–Ω—Ç);
        self.—É—Å–ª–æ–≤–∏–µ.notify_one();
    }
    
    fn –≤–∑—è—Ç—å(&self) -> T {
        let mut –æ—á–µ—Ä–µ–¥—å = self.–¥–∞–Ω–Ω—ã–µ.lock().unwrap();
        while –æ—á–µ—Ä–µ–¥—å.is_empty() {
            –æ—á–µ—Ä–µ–¥—å = self.—É—Å–ª–æ–≤–∏–µ.wait(–æ—á–µ—Ä–µ–¥—å).unwrap();
        }
        –æ—á–µ—Ä–µ–¥—å.pop_front().unwrap()
    }
}
```

## ‚ö° Rayon - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```toml
[dependencies]
rayon = "1.5"
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```rust
use rayon::prelude::*;

fn main() {
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    let —á–∏—Å–ª–∞: Vec<i32> = (1..100).collect();
    
    // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
    let —Å—É–º–º–∞: i32 = —á–∏—Å–ª–∞.iter().map(|&x| x * x).sum();
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
    let –ø–∞—Ä_—Å—É–º–º–∞: i32 = —á–∏—Å–ª–∞.par_iter().map(|&x| x * x).sum();
    
    assert_eq!(—Å—É–º–º–∞, –ø–∞—Ä_—Å—É–º–º–∞);
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    let mut –¥–∞–Ω–Ω—ã–µ = vec![5, 2, 8, 1, 9, 3];
    –¥–∞–Ω–Ω—ã–µ.par_sort();
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
    let —Ä–µ–∑—É–ª—å—Ç–∞—Ç = —á–∏—Å–ª–∞.par_iter()
        .find_any(|&&x| x > 50)
        .copied();
}
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
```rust
use rayon::prelude::*;

fn main() {
    let mut —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã = vec![0; 1000];
    
    —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.par_iter_mut()
        .enumerate()
        .for_each(|(i, —ç–ª–µ–º–µ–Ω—Ç)| {
            *—ç–ª–µ–º–µ–Ω—Ç = —Å–ª–æ–∂–Ω–æ–µ_–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ(i);
        });
}

fn —Å–ª–æ–∂–Ω–æ–µ_–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ(n: usize) -> i32 {
    // –ò–º–∏—Ç–∞—Ü–∏—è —Å–ª–æ–∂–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    (n as i32).pow(2)
}
```

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### Web Crawler
```rust
use std::sync::{Arc, Mutex};
use std::collections::HashSet;
use std::thread;

struct –ö—Ä–∞—É–ª–µ—Ä {
    –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ: Arc<Mutex<HashSet<String>>>,
    –æ—á–µ—Ä–µ–¥—å: Arc<Mutex<Vec<String>>>,
}

impl –ö—Ä–∞—É–ª–µ—Ä {
    fn –Ω–æ–≤—ã–π(–Ω–∞—á–∞–ª—å–Ω—ã–π_url: String) -> Self {
        let mut –æ—á–µ—Ä–µ–¥—å = Vec::new();
        –æ—á–µ—Ä–µ–¥—å.push(–Ω–∞—á–∞–ª—å–Ω—ã–π_url);
        
        –ö—Ä–∞—É–ª–µ—Ä {
            –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ: Arc::new(Mutex::new(HashSet::new())),
            –æ—á–µ—Ä–µ–¥—å: Arc::new(Mutex::new(–æ—á–µ—Ä–µ–¥—å)),
        }
    }
    
    fn –∫—Ä–∞—É–ª–∏—Ç—å(&self) {
        let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
        
        for _ in 0..4 { // 4 –ø–æ—Ç–æ–∫–∞
            let –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ = Arc::clone(&self.–ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ);
            let –æ—á–µ—Ä–µ–¥—å = Arc::clone(&self.–æ—á–µ—Ä–µ–¥—å);
            
            let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
                loop {
                    let url = {
                        let mut –æ—á–µ—Ä–µ–¥—å = –æ—á–µ—Ä–µ–¥—å.lock().unwrap();
                        –æ—á–µ—Ä–µ–¥—å.pop()
                    };
                    
                    if let Some(url) = url {
                        let mut –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ = –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ.lock().unwrap();
                        if !–ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ.contains(&url) {
                            –ø–æ—Å–µ—â—ë–Ω–Ω—ã–µ.insert(url.clone());
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ URL
                            println!("–û–±—Ä–∞–±–æ—Ç–∫–∞: {}", url);
                        }
                    } else {
                        break;
                    }
                }
            });
            
            –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
        }
        
        for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
            –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
        }
    }
}
```

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: Deadlock
```rust
// ‚ùå DEADLOCK!
let –±–ª–æ–∫1 = Arc::new(Mutex::new(1));
let –±–ª–æ–∫2 = Arc::new(Mutex::new(2));

let –±1 = –±–ª–æ–∫1.clone();
let –±2 = –±–ª–æ–∫2.clone();

thread::spawn(move || {
    let _–≥1 = –±1.lock().unwrap();
    thread::sleep(Duration::from_millis(10));
    let _–≥2 = –±2.lock().unwrap();
});

let _–≥2 = –±–ª–æ–∫2.lock().unwrap();
thread::sleep(Duration::from_millis(10));
let _–≥1 = –±–ª–æ–∫1.lock().unwrap();

// ‚úÖ –†–µ—à–µ–Ω–∏–µ: –≤—Å–µ–≥–¥–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
```

### –û—à–∏–±–∫–∞ 2: –û—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ Mutex
```rust
// –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –ø–∞–Ω–∏–∫—É–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, Mutex –æ—Ç—Ä–∞–≤–ª—è–µ—Ç—Å—è
let –¥–∞–Ω–Ω—ã–µ = Arc::new(Mutex::new(vec![1, 2, 3]));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è
match –¥–∞–Ω–Ω—ã–µ.lock() {
    Ok(guard) => { /* —Ä–∞–±–æ—Ç–∞–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏ */ },
    Err(poisoned) => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –æ—Ç –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è
        let mut guard = poisoned.into_inner();
        // –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }
}
```

## üéØ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π merge sort**
2. **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –∞–∫—Ç–æ—Ä–æ–≤** —Å –æ–±–º–µ–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
3. **–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π web scraper**
4. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ map-reduce** –ø–∞—Ç—Ç–µ—Ä–Ω

## üí° –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–Ω–∞–ª—ã** –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏
2. **–ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è** —É–¥–µ—Ä–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
3. **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ Arc<Mutex<T>>** –¥–ª—è —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Rayon** –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
5. **–ò–∑–±–µ–≥–∞–π—Ç–µ deadlock** —á–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
6. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π –∫–æ–¥ —Ç—â–∞—Ç–µ–ª—å–Ω–æ

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã

- [[12_–£–º–Ω—ã–µ_—É–∫–∞–∑–∞—Ç–µ–ª–∏/00_–ò–Ω–¥–µ–∫—Å|Arc –∏ —É–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏]]
- [[14_–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å/00_–ò–Ω–¥–µ–∫—Å|Async/await]]
- [[07_–û–±—Ä–∞–±–æ—Ç–∫–∞_–æ—à–∏–±–æ–∫/00_–ò–Ω–¥–µ–∫—Å|–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ø–æ—Ç–æ–∫–∞—Ö]]

---
#rust #–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å #–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º #threads #channels #mutex

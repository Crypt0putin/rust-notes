# üß† –£–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ Rust

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ —É–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏](#—á—Ç–æ-—Ç–∞–∫–æ–µ-—É–º–Ω—ã–µ-—É–∫–∞–∑–∞—Ç–µ–ª–∏)
2. [Box<T> - —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –∫—É—á–µ](#box-—Ä–∞–∑–º–µ—â–µ–Ω–∏–µ-–Ω–∞-–∫—É—á–µ)
3. [Rc<T> - –ø–æ–¥—Å—á—ë—Ç —Å—Å—ã–ª–æ–∫](#rc-–ø–æ–¥—Å—á—ë—Ç-—Å—Å—ã–ª–æ–∫)
4. [Arc<T> - –∞—Ç–æ–º–∞—Ä–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç](#arc-–∞—Ç–æ–º–∞—Ä–Ω—ã–π-–ø–æ–¥—Å—á—ë—Ç)
5. [RefCell<T> - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å](#refcell-–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è-–∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å)
6. [Weak<T> - —Å–ª–∞–±—ã–µ —Å—Å—ã–ª–∫–∏](#weak-—Å–ª–∞–±—ã–µ-—Å—Å—ã–ª–∫–∏)
7. [–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —É–º–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π](#–∫–æ–º–±–∏–Ω–∞—Ü–∏–∏-—É–º–Ω—ã—Ö-—É–∫–∞–∑–∞—Ç–µ–ª–µ–π)

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ —É–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏?

**–£–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏** - —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É—é—Ç –∫–∞–∫ —É–∫–∞–∑–∞—Ç–µ–ª–∏, –Ω–æ –∏ –∏–º–µ—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫, —É–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ —á–∞—Å—Ç–æ –≤–ª–∞–¥–µ—é—Ç –¥–∞–Ω–Ω—ã–º–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç.

### –û—Å–Ω–æ–≤–Ω—ã–µ —É–º–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏
- `Box<T>` - –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ –∫—É—á–µ
- `Rc<T>` - Reference Counting –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–ª–∞–¥–µ–Ω–∏—è
- `Arc<T>` - Atomic Reference Counting –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
- `RefCell<T>` - –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç–∏
- `Cell<T>` - –¥–ª—è Copy —Ç–∏–ø–æ–≤ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å—é
- `Mutex<T>` - –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- `RwLock<T>` - –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏

## üì¶ Box<T> - —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –∫—É—á–µ

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Box
```rust
// 1. –ö–æ–≥–¥–∞ —Ä–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –≤–æ –≤—Ä–µ–º—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
enum –°–ø–∏—Å–æ–∫ {
    –≠–ª–µ–º–µ–Ω—Ç(i32, Box<–°–ø–∏—Å–æ–∫>),
    –ö–æ–Ω–µ—Ü,
}

// 2. –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤–ª–∞–¥–µ–Ω–∏–µ –±–æ–ª—å—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
struct –ë–æ–ª—å—à–∞—è–°—Ç—Ä—É–∫—Ç—É—Ä–∞([u8; 1000000]);

fn –ø–µ—Ä–µ–¥–∞—Ç—å_–≤–ª–∞–¥–µ–Ω–∏–µ(–¥–∞–Ω–Ω—ã–µ: Box<–ë–æ–ª—å—à–∞—è–°—Ç—Ä—É–∫—Ç—É—Ä–∞>) {
    // –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª—å, –Ω–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –º–µ–≥–∞–±–∞–π—Ç—ã
}

// 3. –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω trait object
trait –†–∏—Å—É–µ–º—ã–π {
    fn –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å(&self);
}

let –æ–±—ä–µ–∫—Ç—ã: Vec<Box<dyn –†–∏—Å—É–µ–º—ã–π>> = vec![];
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Box
```rust
fn main() {
    // –°–æ–∑–¥–∞–Ω–∏–µ Box
    let b = Box::new(5);
    println!("b = {}", b);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ
    let x = 5;
    let y = Box::new(x);
    
    assert_eq!(5, x);
    assert_eq!(5, *y);
    
    // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–µ —Ç–∏–ø—ã
    use –°–ø–∏—Å–æ–∫::{–≠–ª–µ–º–µ–Ω—Ç, –ö–æ–Ω–µ—Ü};
    
    let —Å–ø–∏—Å–æ–∫ = –≠–ª–µ–º–µ–Ω—Ç(1,
        Box::new(–≠–ª–µ–º–µ–Ω—Ç(2,
            Box::new(–≠–ª–µ–º–µ–Ω—Ç(3,
                Box::new(–ö–æ–Ω–µ—Ü))))));
}
```

### Box –∏ trait objects
```rust
trait –ñ–∏–≤–æ—Ç–Ω–æ–µ {
    fn –∑–≤—É–∫(&self) -> &str;
}

struct –°–æ–±–∞–∫–∞;
struct –ö–æ—à–∫–∞;

impl –ñ–∏–≤–æ—Ç–Ω–æ–µ for –°–æ–±–∞–∫–∞ {
    fn –∑–≤—É–∫(&self) -> &str {
        "–ì–∞–≤!"
    }
}

impl –ñ–∏–≤–æ—Ç–Ω–æ–µ for –ö–æ—à–∫–∞ {
    fn –∑–≤—É–∫(&self) -> &str {
        "–ú—è—É!"
    }
}

fn main() {
    let –∂–∏–≤–æ—Ç–Ω—ã–µ: Vec<Box<dyn –ñ–∏–≤–æ—Ç–Ω–æ–µ>> = vec![
        Box::new(–°–æ–±–∞–∫–∞),
        Box::new(–ö–æ—à–∫–∞),
    ];
    
    for –∂–∏–≤–æ—Ç–Ω–æ–µ in –∂–∏–≤–æ—Ç–Ω—ã–µ {
        println!("–ñ–∏–≤–æ—Ç–Ω–æ–µ –≥–æ–≤–æ—Ä–∏—Ç: {}", –∂–∏–≤–æ—Ç–Ω–æ–µ.–∑–≤—É–∫());
    }
}
```

## üîÑ Rc<T> - –ø–æ–¥—Å—á—ë—Ç —Å—Å—ã–ª–æ–∫

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Rc
```rust
use std::rc::Rc;

// –ö–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–æ–ª–∂–Ω—ã —á–∏—Ç–∞—Ç—å –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ
// –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –∫–∞–∫–∞—è —á–∞—Å—Ç—å –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–π

#[derive(Debug)]
struct –£–∑–µ–ª {
    –∑–Ω–∞—á–µ–Ω–∏–µ: i32,
    –¥–µ—Ç–∏: Vec<Rc<–£–∑–µ–ª>>,
}

fn main() {
    let –ª–∏—Å—Ç = Rc::new(–£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 3,
        –¥–µ—Ç–∏: vec![],
    });
    
    let –≤–µ—Ç–∫–∞ = –£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 5,
        –¥–µ—Ç–∏: vec![Rc::clone(&–ª–∏—Å—Ç)],
    };
    
    let –¥–µ—Ä–µ–≤–æ = –£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 10,
        –¥–µ—Ç–∏: vec![Rc::clone(&–ª–∏—Å—Ç)],
    };
    
    // –ª–∏—Å—Ç –∏–º–µ–µ—Ç 3 –≤–ª–∞–¥–µ–ª—å—Ü–∞
    println!("–°—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫: {}", Rc::strong_count(&–ª–∏—Å—Ç));
}
```

### –ú–µ—Ç–æ–¥—ã Rc
```rust
use std::rc::Rc;

fn main() {
    let –ø—è—Ç—å = Rc::new(5);
    
    // –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫
    let –ø—è—Ç—å2 = Rc::clone(&–ø—è—Ç—å);
    let –ø—è—Ç—å3 = –ø—è—Ç—å.clone(); // –¢–æ –∂–µ —Å–∞–º–æ–µ
    
    println!("–°—á—ë—Ç—á–∏–∫: {}", Rc::strong_count(&–ø—è—Ç—å)); // 3
    
    {
        let –ø—è—Ç—å4 = Rc::clone(&–ø—è—Ç—å);
        println!("–í–Ω—É—Ç—Ä–∏: {}", Rc::strong_count(&–ø—è—Ç—å)); // 4
    } // –ø—è—Ç—å4 —É–¥–∞–ª—è–µ—Ç—Å—è, —Å—á—ë—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
    
    println!("–ü–æ—Å–ª–µ: {}", Rc::strong_count(&–ø—è—Ç—å)); // 3
    
    // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑–º–µ–Ω—è–µ–º—É—é —Å—Å—ã–ª–∫—É
    // let mut_ref = Rc::get_mut(&mut –ø—è—Ç—å); // –í–µ—Ä–Ω—ë—Ç None –µ—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ > 1
}
```

## ‚öõÔ∏è Arc<T> - –∞—Ç–æ–º–∞—Ä–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç —Å—Å—ã–ª–æ–∫

### Arc –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
```rust
use std::sync::Arc;
use std::thread;

fn main() {
    let —á–∏—Å–ª–∞ = Arc::new(vec![1, 2, 3, 4, 5]);
    let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
    
    for i in 0..3 {
        let —á–∏—Å–ª–∞ = Arc::clone(&—á–∏—Å–ª–∞);
        let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
            let —Å—É–º–º–∞: i32 = —á–∏—Å–ª–∞.iter().sum();
            println!("–ü–æ—Ç–æ–∫ {}: —Å—É–º–º–∞ = {}", i, —Å—É–º–º–∞);
        });
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
    }
    
    for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
    }
}
```

### Arc —Å Mutex –¥–ª—è –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç–∏
```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let —Å—á—ë—Ç—á–∏–∫ = Arc::new(Mutex::new(0));
    let mut –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã = vec![];
    
    for _ in 0..10 {
        let —Å—á—ë—Ç—á–∏–∫ = Arc::clone(&—Å—á—ë—Ç—á–∏–∫);
        let –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä = thread::spawn(move || {
            let mut num = —Å—á—ë—Ç—á–∏–∫.lock().unwrap();
            *num += 1;
        });
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.push(–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä);
    }
    
    for –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä in –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã {
        –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.join().unwrap();
    }
    
    println!("–†–µ–∑—É–ª—å—Ç–∞—Ç: {}", *—Å—á—ë—Ç—á–∏–∫.lock().unwrap());
}
```

## üîê RefCell<T> - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å

### –ü–∞—Ç—Ç–µ—Ä–Ω –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç–∏
```rust
use std::cell::RefCell;

#[derive(Debug)]
struct –°–æ–æ–±—â–µ–Ω–∏–µ {
    —Ç–µ–∫—Å—Ç: RefCell<String>,
}

impl –°–æ–æ–±—â–µ–Ω–∏–µ {
    fn –Ω–æ–≤–æ–µ(—Ç–µ–∫—Å—Ç: &str) -> Self {
        –°–æ–æ–±—â–µ–Ω–∏–µ {
            —Ç–µ–∫—Å—Ç: RefCell::new(String::from(—Ç–µ–∫—Å—Ç)),
        }
    }
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—É—é —Å—Å—ã–ª–∫—É!
    fn –∏–∑–º–µ–Ω–∏—Ç—å(&self, –Ω–æ–≤—ã–π_—Ç–µ–∫—Å—Ç: &str) {
        *self.—Ç–µ–∫—Å—Ç.borrow_mut() = String::from(–Ω–æ–≤—ã–π_—Ç–µ–∫—Å—Ç);
    }
    
    fn –ø–æ–ª—É—á–∏—Ç—å(&self) -> String {
        self.—Ç–µ–∫—Å—Ç.borrow().clone()
    }
}

fn main() {
    let —Å–æ–æ–±—â–µ–Ω–∏–µ = –°–æ–æ–±—â–µ–Ω–∏–µ::–Ω–æ–≤–æ–µ("–ü—Ä–∏–≤–µ—Ç");
    println!("–î–æ: {:?}", —Å–æ–æ–±—â–µ–Ω–∏–µ);
    
    —Å–æ–æ–±—â–µ–Ω–∏–µ.–∏–∑–º–µ–Ω–∏—Ç—å("–ü–æ–∫–∞");
    println!("–ü–æ—Å–ª–µ: {:?}", —Å–æ–æ–±—â–µ–Ω–∏–µ);
}
```

### RefCell —Å Rc
```rust
use std::cell::RefCell;
use std::rc::Rc;

#[derive(Debug)]
struct –£–∑–µ–ª {
    –∑–Ω–∞—á–µ–Ω–∏–µ: i32,
    —Å–ª–µ–¥—É—é—â–∏–π: Option<Rc<RefCell<–£–∑–µ–ª>>>,
}

fn main() {
    let –ø–µ—Ä–≤—ã–π = Rc::new(RefCell::new(–£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 1,
        —Å–ª–µ–¥—É—é—â–∏–π: None,
    }));
    
    let –≤—Ç–æ—Ä–æ–π = Rc::new(RefCell::new(–£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 2,
        —Å–ª–µ–¥—É—é—â–∏–π: Some(Rc::clone(&–ø–µ—Ä–≤—ã–π)),
    }));
    
    // –ò–∑–º–µ–Ω—è–µ–º –ø–µ—Ä–≤—ã–π —É–∑–µ–ª —á–µ—Ä–µ–∑ –≤—Ç–æ—Ä–æ–π
    if let Some(ref —É–∑–µ–ª) = –≤—Ç–æ—Ä–æ–π.borrow().—Å–ª–µ–¥—É—é—â–∏–π {
        —É–∑–µ–ª.borrow_mut().–∑–Ω–∞—á–µ–Ω–∏–µ = 10;
    }
    
    println!("–ü–µ—Ä–≤—ã–π —É–∑–µ–ª: {:?}", –ø–µ—Ä–≤—ã–π.borrow().–∑–Ω–∞—á–µ–Ω–∏–µ); // 10
}
```

### –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ runtime
```rust
use std::cell::RefCell;

fn main() {
    let –∑–Ω–∞—á–µ–Ω–∏–µ = RefCell::new(5);
    
    let –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ1 = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow();
    let –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ2 = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow(); // OK: –º–Ω–æ–≥–æ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö
    
    // let –∏–∑–º_–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow_mut(); // –ü–ê–ù–ò–ö–ê –≤ runtime!
    
    drop(–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ1);
    drop(–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ2);
    
    let –∏–∑–º_–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow_mut(); // –¢–µ–ø–µ—Ä—å OK
    *–∏–∑–º_–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ += 1;
}
```

## üîó Weak<T> - —Å–ª–∞–±—ã–µ —Å—Å—ã–ª–∫–∏

### –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
```rust
use std::cell::RefCell;
use std::rc::{Rc, Weak};

#[derive(Debug)]
struct –£–∑–µ–ª {
    –∑–Ω–∞—á–µ–Ω–∏–µ: i32,
    —Ä–æ–¥–∏—Ç–µ–ª—å: RefCell<Weak<–£–∑–µ–ª>>,
    –¥–µ—Ç–∏: RefCell<Vec<Rc<–£–∑–µ–ª>>>,
}

fn main() {
    let –ª–∏—Å—Ç = Rc::new(–£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 3,
        —Ä–æ–¥–∏—Ç–µ–ª—å: RefCell::new(Weak::new()),
        –¥–µ—Ç–∏: RefCell::new(vec![]),
    });
    
    println!("–†–æ–¥–∏—Ç–µ–ª—å –ª–∏—Å—Ç–∞: {:?}", –ª–∏—Å—Ç.—Ä–æ–¥–∏—Ç–µ–ª—å.borrow().upgrade());
    
    let –≤–µ—Ç–∫–∞ = Rc::new(–£–∑–µ–ª {
        –∑–Ω–∞—á–µ–Ω–∏–µ: 5,
        —Ä–æ–¥–∏—Ç–µ–ª—å: RefCell::new(Weak::new()),
        –¥–µ—Ç–∏: RefCell::new(vec![Rc::clone(&–ª–∏—Å—Ç)]),
    });
    
    *–ª–∏—Å—Ç.—Ä–æ–¥–∏—Ç–µ–ª—å.borrow_mut() = Rc::downgrade(&–≤–µ—Ç–∫–∞);
    
    // Weak –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ strong_count
    println!("strong = {}, weak = {}",
        Rc::strong_count(&–≤–µ—Ç–∫–∞),
        Rc::weak_count(&–≤–µ—Ç–∫–∞));
}
```

## üé® –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —É–º–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π

### –¢–∏–ø–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
```rust
// 1. Rc<RefCell<T>> - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ —Å –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å—é
type –†–∞–∑–¥–µ–ª—è–µ–º—ã–π–ò–∑–º–µ–Ω—è–µ–º—ã–π<T> = Rc<RefCell<T>>;

// 2. Arc<Mutex<T>> - –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
type –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ–°–æ—Å—Ç–æ—è–Ω–∏–µ<T> = Arc<Mutex<T>>;

// 3. Arc<RwLock<T>> - –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å
type –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ–ß—Ç–µ–Ω–∏–µ–ó–∞–ø–∏—Å—å<T> = Arc<RwLock<T>>;

// 4. Box<dyn Trait> - trait objects
type –¢—Ä–µ–π—Ç–û–±—ä–µ–∫—Ç = Box<dyn std::any::Any>;
```

### –ü—Ä–∏–º–µ—Ä: –≥—Ä–∞—Ñ —Å —Ü–∏–∫–ª–∞–º–∏
```rust
use std::cell::RefCell;
use std::rc::{Rc, Weak};

struct –í–µ—Ä—à–∏–Ω–∞ {
    –∑–Ω–∞—á–µ–Ω–∏–µ: i32,
    —Å–æ—Å–µ–¥–∏: RefCell<Vec<Weak<–í–µ—Ä—à–∏–Ω–∞>>>,
}

impl –í–µ—Ä—à–∏–Ω–∞ {
    fn –Ω–æ–≤–∞—è(–∑–Ω–∞—á–µ–Ω–∏–µ: i32) -> Rc<Self> {
        Rc::new(–í–µ—Ä—à–∏–Ω–∞ {
            –∑–Ω–∞—á–µ–Ω–∏–µ,
            —Å–æ—Å–µ–¥–∏: RefCell::new(vec![]),
        })
    }
    
    fn –¥–æ–±–∞–≤–∏—Ç—å_—Å–æ—Å–µ–¥–∞(–≤–µ—Ä—à–∏–Ω–∞: &Rc<Self>, —Å–æ—Å–µ–¥: &Rc<Self>) {
        –≤–µ—Ä—à–∏–Ω–∞.—Å–æ—Å–µ–¥–∏.borrow_mut().push(Rc::downgrade(—Å–æ—Å–µ–¥));
    }
}
```

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

### –ö–µ—à —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Å—Å—ã–ª–æ–∫
```rust
use std::cell::RefCell;
use std::collections::HashMap;
use std::rc::Rc;

struct –ö–µ—à<T> {
    –¥–∞–Ω–Ω—ã–µ: RefCell<HashMap<String, Rc<T>>>,
}

impl<T> –ö–µ—à<T> {
    fn –Ω–æ–≤—ã–π() -> Self {
        –ö–µ—à {
            –¥–∞–Ω–Ω—ã–µ: RefCell::new(HashMap::new()),
        }
    }
    
    fn –ø–æ–ª—É—á–∏—Ç—å(&self, –∫–ª—é—á: &str) -> Option<Rc<T>> {
        self.–¥–∞–Ω–Ω—ã–µ.borrow().get(–∫–ª—é—á).cloned()
    }
    
    fn –≤—Å—Ç–∞–≤–∏—Ç—å(&self, –∫–ª—é—á: String, –∑–Ω–∞—á–µ–Ω–∏–µ: T) -> Rc<T> {
        let rc = Rc::new(–∑–Ω–∞—á–µ–Ω–∏–µ);
        self.–¥–∞–Ω–Ω—ã–µ.borrow_mut().insert(–∫–ª—é—á, Rc::clone(&rc));
        rc
    }
}
```

### –î–µ—Ä–µ–≤–æ —Å –æ–±—Ä–∞—Ç–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
```rust
use std::cell::RefCell;
use std::rc::{Rc, Weak};

#[derive(Debug)]
struct –î–µ—Ä–µ–≤–æ–£–∑–µ–ª<T> {
    –∑–Ω–∞—á–µ–Ω–∏–µ: T,
    —Ä–æ–¥–∏—Ç–µ–ª—å: RefCell<Weak<–î–µ—Ä–µ–≤–æ–£–∑–µ–ª<T>>>,
    –¥–µ—Ç–∏: RefCell<Vec<Rc<–î–µ—Ä–µ–≤–æ–£–∑–µ–ª<T>>>>,
}

impl<T> –î–µ—Ä–µ–≤–æ–£–∑–µ–ª<T> {
    fn –Ω–æ–≤—ã–π(–∑–Ω–∞—á–µ–Ω–∏–µ: T) -> Rc<Self> {
        Rc::new(–î–µ—Ä–µ–≤–æ–£–∑–µ–ª {
            –∑–Ω–∞—á–µ–Ω–∏–µ,
            —Ä–æ–¥–∏—Ç–µ–ª—å: RefCell::new(Weak::new()),
            –¥–µ—Ç–∏: RefCell::new(Vec::new()),
        })
    }
    
    fn –¥–æ–±–∞–≤–∏—Ç—å_—Ä–µ–±—ë–Ω–∫–∞(—Ä–æ–¥–∏—Ç–µ–ª—å: &Rc<Self>, —Ä–µ–±—ë–Ω–æ–∫: Rc<Self>) {
        *—Ä–µ–±—ë–Ω–æ–∫.—Ä–æ–¥–∏—Ç–µ–ª—å.borrow_mut() = Rc::downgrade(—Ä–æ–¥–∏—Ç–µ–ª—å);
        —Ä–æ–¥–∏—Ç–µ–ª—å.–¥–µ—Ç–∏.borrow_mut().push(—Ä–µ–±—ë–Ω–æ–∫);
    }
    
    fn –ø—Ä–µ–¥–∫–∏(&self) -> Vec<Rc<–î–µ—Ä–µ–≤–æ–£–∑–µ–ª<T>>> {
        let mut —Ä–µ–∑—É–ª—å—Ç–∞—Ç = Vec::new();
        let mut —Ç–µ–∫—É—â–∏–π = self.—Ä–æ–¥–∏—Ç–µ–ª—å.borrow().upgrade();
        
        while let Some(—É–∑–µ–ª) = —Ç–µ–∫—É—â–∏–π {
            —Ä–µ–∑—É–ª—å—Ç–∞—Ç.push(Rc::clone(&—É–∑–µ–ª));
            —Ç–µ–∫—É—â–∏–π = —É–∑–µ–ª.—Ä–æ–¥–∏—Ç–µ–ª—å.borrow().upgrade();
        }
        
        —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    }
}
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É–º–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π
| –£–∫–∞–∑–∞—Ç–µ–ª—å | –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã | –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å | –ò–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å |
|-----------|-------------------|-----------------|--------------|
| `Box<T>` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ | –ù–µ—Ç | –î–∞ |
| `Rc<T>` | –°—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ | –ù–µ—Ç | –ù–µ—Ç |
| `Arc<T>` | –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ | –î–∞ | –ù–µ—Ç |
| `RefCell<T>` | Runtime –ø—Ä–æ–≤–µ—Ä–∫–∏ | –ù–µ—Ç | –î–∞ |
| `Cell<T>` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ | –ù–µ—Ç | –î–∞ (Copy) |
| `Mutex<T>` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | –î–∞ | –î–∞ |
| `RwLock<T>` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ R/W | –î–∞ | –î–∞ |

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏
```rust
// ‚ùå –ü–õ–û–•–û: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏
use std::rc::Rc;
use std::cell::RefCell;

struct –£–∑–µ–ª {
    —Å–ª–µ–¥—É—é—â–∏–π: Option<Rc<RefCell<–£–∑–µ–ª>>>,
}

// –°–æ–∑–¥–∞—ë–º —Ü–∏–∫–ª
let –∞ = Rc::new(RefCell::new(–£–∑–µ–ª { —Å–ª–µ–¥—É—é—â–∏–π: None }));
let –± = Rc::new(RefCell::new(–£–∑–µ–ª { —Å–ª–µ–¥—É—é—â–∏–π: Some(–∞.clone()) }));
–∞.borrow_mut().—Å–ª–µ–¥—É—é—â–∏–π = Some(–±.clone());
// –ü–∞–º—è—Ç—å –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è!

// ‚úÖ –•–û–†–û–®–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Weak –¥–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
```

### –û—à–∏–±–∫–∞ 2: –ü–∞–Ω–∏–∫–∞ –≤ RefCell
```rust
// ‚ùå –ü–∞–Ω–∏–∫–∞ –≤ runtime
let –∑–Ω–∞—á–µ–Ω–∏–µ = RefCell::new(5);
let –∑1 = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow();
let –∑2 = –∑–Ω–∞—á–µ–Ω–∏–µ.borrow_mut(); // –ü–ê–ù–ò–ö–ê!

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ try_borrow
if let Ok(–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ) = –∑–Ω–∞—á–µ–Ω–∏–µ.try_borrow_mut() {
    // –†–∞–±–æ—Ç–∞–µ–º —Å –∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º
}
```

## üéØ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è

1. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –¥–≤—É—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Rc –∏ RefCell
2. **–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä–∞—Ñ** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±—Ö–æ–¥–∞ –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
3. **–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Å—á—ë—Ç—á–∏–∫** —Å Arc –∏ Mutex
4. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω Observer** —Å Weak —Å—Å—ã–ª–∫–∞–º–∏

## üí° –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Box** –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ –∫—É—á–µ
2. **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ Rc –ø–µ—Ä–µ–¥ Arc** –≤ –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–º –∫–æ–¥–µ
3. **–ò–∑–±–µ–≥–∞–π—Ç–µ RefCell** –µ—Å–ª–∏ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –Ω–µ–≥–æ
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Weak** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–æ–≤
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã** –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ RefCell
6. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏** –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö

## üìä –®–ø–∞—Ä–≥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞

```rust
// –ù—É–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –∫—É—á–µ?
Box<T>

// –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ?
Rc<T> // –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–µ
Arc<T> // –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ

// –ù—É–∂–Ω–∞ –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –æ–±—â–µ–µ –≤–ª–∞–¥–µ–Ω–∏–µ?
Rc<RefCell<T>> // –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–µ
Arc<Mutex<T>> // –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ
Arc<RwLock<T>> // –º–Ω–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π, –æ–¥–∏–Ω –ø–∏—Å–∞—Ç–µ–ª—å

// –ù—É–∂–Ω—ã –æ–±—Ä–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏?
Weak<T> // —Å Rc
Arc::downgrade() // —Å Arc
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã

- [[02_–í–ª–∞–¥–µ–Ω–∏–µ_–∏_–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ/00_–ò–Ω–¥–µ–∫—Å|–°–∏—Å—Ç–µ–º–∞ –≤–ª–∞–¥–µ–Ω–∏—è]]
- [[13_–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å/00_–ò–Ω–¥–µ–∫—Å|–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å —Å Arc]]
- [[09_–í—Ä–µ–º–µ–Ω–∞_–∂–∏–∑–Ω–∏/00_–ò–Ω–¥–µ–∫—Å|–í—Ä–µ–º–µ–Ω–∞ –∂–∏–∑–Ω–∏]]
- [[08_–¢—Ä–µ–π—Ç—ã/00_–ò–Ω–¥–µ–∫—Å|Deref –∏ Drop —Ç—Ä–µ–π—Ç—ã]]

---
#rust #—É–º–Ω—ã–µ_—É–∫–∞–∑–∞—Ç–µ–ª–∏ #box #rc #arc #refcell #–ø–∞–º—è—Ç—å
